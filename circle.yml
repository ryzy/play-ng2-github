machine:
  node:
    version: 6.9.2

dependencies:
  cache_directories:
    - ~/.cache/yarn # Add yarn cache to CircleCI cache (shared between builds)

  pre:
    # Install yarn
    - curl -o- -L https://yarnpkg.com/install.sh | bash

  override:
    - rm -rf node_modules # Remove this restored by CircleCI. Utilise yarn cache instead.
    - yarn install

  post:
    # Launch app, so it's ready for e2e tests running later on
    - yarn run start:
        background: true

test:
  override:
    - yarn run lint
    - yarn run test:ci
    - yarn run build # test the dev build as well, to make sure it works
    - yarn run e2e

  post:
    # Prepare production build
    # TODO: make it AoT once https://github.com/angular/angular-cli/issues/2799 is fixed
    # as @ngrx/effects doesn't work currently with AoT.
    - yarn run build:prod

deployment:
  production: # Deploy `master` to https://ng2-github.firebaseapp.com/
    branch: master
    commands:
      - yarn run deploy:prod

  development: # Deploy `dev` to https://dev-ng2-github-d52c4.firebaseio.com/
    branch: dev
    commands:
      - yarn run deploy
